# Обзор PM2

## Введение в PM2
PM2 (Process Manager 2) — это менеджер процессов промышленного уровня для приложений на Node.js. Он помогает управлять и мониторить ваши приложения, чтобы они работали непрерывно, предлагая такие функции, как автоматический перезапуск, управление логами и кластеризация.

Это руководство познакомит вас с основами PM2, более продвинутыми возможностями, такими как сопоставление по шаблону, настройка ротации логов и советы по работе с ОС для пользователей Ubuntu и Windows.

## 1. Основные команды PM2

Вот несколько основных команд для начала работы с PM2:

- **Показать все процессы, управляемые PM2**:  
  ```
  pm2 list
  ```
  <img width="554" alt="image" src="https://github.com/user-attachments/assets/b2765895-208d-47b9-a39c-f5a03554a914">

- **Запустить существующий остановленный процесс**: `pm2 start <game_session>` или `pm2 start <ID>` или `pm2 start all`. Пример:
  ```
  pm2 start Blum:Phil
  
  pm2 start 46
  
  pm2 start all
  ```

- **Просмотреть логи конкретного процесса**: `pm2 log <game_session>` или `pm2 log <ID>` или `pm2 log` для всех процессов
  ```
  pm2 log 
  ```

- **Перезапустить процесс**: `pm2 restart <game_session>` или `pm2 restart <ID>` или `pm2 restart all`
  ```
  pm2 restart Vertus:Wallet2
  ```

- **Удалить процесс из PM2**: `pm2 delete <game_session>` или `pm2 delete <ID>` или `pm2 delete all`
  ```
  pm2 delete Cryptorank:Wallet1
  ```

- **Сохранить текущий список процессов** (после добавления или удаления процессов):  
  ```
  pm2 save
  ```

## 2. Продвинутые команды PM2 (Сопоставление по шаблону)

PM2 поддерживает сопоставление по шаблону, что полезно при управлении несколькими похожими процессами. Это работает только с командами **stop** и **restart**:

- **Перезапуск процессов с использованием сопоставления по шаблону**:  
  ```
  pm2 restart /pattern/
  ```

  Пример для перезапуска всех HOT игр независимо от имени аккаунта/сессии:
  ```
  pm2 restart /HOT:/
  ```
  Это перезапустит: HOT:Wallet1 HOT:Wallet2 HOT:Wallet3 и т.д.

  Пример для остановки всех сессий аккаунта с определённым именем независимо от игры:
  ```
  pm2 stop /:Wallet1/
  ```
  Это остановит: HOT:Wallet1, Vertus:Wallet1, HammyKombat:Wallet1 и т.д.

## 3. Настройка ротации логов PM2

PM2 может управлять файлами логов, чтобы они не занимали слишком много места на диске.

Для настройки ротации логов PM2 следуйте подробному руководству в отдельном файле [PM2-LOGS.md](https://github.com/Hwoarang91/hot/blob/main/docs/PM2-LOGS.md).

## 4. Обеспечение сохранности PM2 после перезагрузок

### Для пользователей Ubuntu (кроме Docker, который уже настроен):

Чтобы PM2 сохранялся после перезагрузки, выполните следующую команду:
```
pm2 startup systemd
```

Если у вас нет прав суперпользователя, PM2 предложит выполнить команду с `sudo`. Пример такой команды:
```
sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u ubuntu --hp /home/ubuntu
```

### Для пользователей Windows:

Чтобы PM2 автоматически перезапускался после перезагрузки системы:

1. Откройте диалоговое окно «Выполнить», нажав `Win + R`.
2. Введите `shell:startup` и нажмите Enter.
3. Скопируйте файл `windows_pm2_restart.bat` из вашего репозитория GitHub в папку автозагрузки Windows.

Это обеспечит автоматический перезапуск PM2 после перезагрузки.

### Для более подробной информации по каждой ОС смотрите отдельное руководство в папке docs этого репозитория или обучающие видео.

## 5. Установка ограничений на использование диска с помощью ротации логов

Чтобы контролировать размер логов и не допустить заполнения диска, вы можете настроить функцию ротации логов PM2. Подробности настройки смотрите в документе [PM2-LOGS.md](https://github.com/Hwoarang91/hot/blob/main/docs/PM2-LOGS.md).

```
pm2 install pm2-logrotate
pm2 set pm2-logrotate:max_size 100M
pm2 set pm2-logrotate:retain 30
```

Это обеспечит ротацию логов при достижении размера 100 МБ, а PM2 будет хранить последние 30 файлов ротации.

Для дополнительных сведений вы можете изучить документацию PM2 или посмотреть пример скриптов в этом репозитории.